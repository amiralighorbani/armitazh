<!DOCTYPE html>
<html lang="en" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content />
    <meta name="author" content />
    <title>صفحه اصلی</title>
    <link rel="icon" type="image/x-icon" href="/pic/setting.svg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link href="/css/tvstyles.css" rel="stylesheet" />
  </head>
  <style>
    @font-face {
      font-family: "yekan";
      src: url("../font/Yekan.ttf");
    }

    * {
      font-family: "yekan";
      letter-spacing: 0;
    }

    #helper {
      background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.3) 0%,
          rgba(0, 0, 0, 0.7) 75%,
          #000 100%
        ),
        url("./../pic/aarmi.jpg");
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: scroll;
      background-size: cover;
    }

    #btnVideoList:hover {
      transition: 1s ease all;
      background-color: #0e1d34;
      color: aliceblue;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: 0.4s;
      transition: 0.4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 0px;
      bottom: 4px;
      background-color: white;
      -webkit-transition: 0.4s;
      transition: 0.4s;
    }

    input:checked + .slider {
      background-color: #2196f3;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #2196f3;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(26px);
      -ms-transform: translateX(26px);
      transform: translateX(26px);
    }

    /* Rounded sliders */
    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    .selection-bar {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    select {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .hellper:hover {
      transition: all 1s ease;
      color: #2196f3;
      background-color: aliceblue;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    /* Modal content */
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    .hellHelper {
      border: none;
      background: none;
      color: #2196f3;
      position: absolute;
      left: 20px;
      top: 22px;
      font-size: large;
    }

    .manchester {
      border: none;
      background: #c81e1e;
      color: aliceblue;
      width: 100%;
      height: 100%;
      border-radius: 5px;
      height: 40px;
    }

    .manchesterC {
      border: none;
      background: #2196f3;
      color: aliceblue;
      width: 100%;
      height: 100%;
      border-radius: 5px;
      height: 40px;
    }

    .addNewCat {
      border: none;
      background-color: #2196f3;
      color: aliceblue;
      border-radius: 5px;
      padding: 5px 5px;
    }

    #editNameButten,
    #deletetNameButten:hover {
      cursor: pointer;
    }
    .modall {
    display: none;
    position: fixed;
    z-index: 9999;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modall-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
  }

  .loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 2s linear infinite;
  }
  .success-message {
        position: fixed;
        top: 10px;
        left: 10px;
        background-color: #4CAF50;
        color: white;
        padding: 15px;
        border-radius: 5px;
        display: none;
    }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  </style>

  <body>
    <nav class="navbar navbar-expand-lg" style="background-color: #2b2e2f">
      <div class="container px-4 px-lg-5">
        <a class="navbar-brand" href="#!" style="color: aliceblue"
          >به پنل مدیریت خوش آمدید</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
            <li class="nav-item">
              <a
                class="nav-link active"
                aria-current="page"
                href="/tv"
                style="color: aliceblue"
                >صفحه اصلی</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/settings" style="color: aliceblue"
                >تنظیمات</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/tv/b8:27:eb:cd:6d:94"
                id="first"
                style="color: aliceblue"
                >تلویزیون</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/category"
                id="first"
                style="color: aliceblue"
                >دسته بندی ها</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/video"
                id="first"
                style="color: aliceblue"
                >ویدیو ها</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/view"
                id="first"
                style="color: aliceblue"
                >آمار</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/api/logout" style="color: aliceblue"
                >خروج</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <section id="helper" class="py-5">
      <div class="container px-4 px-lg-5 mt-5">
        <div class="row" id="main">
          <div class="card col m-2">
            <!-- <div class="card-header">لیست ویدیو ها</div> -->
            <div class="card-body">
              <blockquote class="blockquote mb-0">
                <ul id="content" style="list-style: none">
                  <li>
                    <div class="row">
                      <div class="col">
                        <h3>نام</h3>
                      </div>
                      <div class="col">
                        <h3>عنوان</h3>
                      </div>
                      <div class="col">
                        <h3>کلی یا خیر</h3>
                      </div>
                      <div class="col"></div>
                    </div>
                    <hr />
                  </li>
                </ul>
                <div>
                  <footer class="blockquote-footer">
                    برای نمایش ویدیو ها روی اسم آنها کلیک کنید
                    <cite title="Source Title"></cite>
                    <button id="sabt" 
                    style="
                    position: absolute;
                    left:70px;
                    border: none;
                    background-color: #2196f3;
                    color: aliceblue;
                    padding: 5px 60px;
                    border-radius: 5px;">ثبت</button>
                  </footer>
                </blockquote>
                </div>
            </div>
            <div id="myModal" class="modal">
              <div class="modal-content">
                <button
                  class="fa-solid fa-close hellHelper"
                  id="closeModal"
                ></button>
                <p>عنوان مورد نظر خود را وارد کنید</p>
                <input
                  type="text"
                  id="nameInput"
                  value=""
                  style="height: 40px"
                />
                <button
                  id="submitName"
                  style="
                    margin: 10px 0px;
                    border: none;
                    background-color: #2196f3;
                    color: aliceblue;
                    height: 40px;
                  "
                >
                  ثبت
                </button>
              </div>
            </div>

            <div id="myModale" class="modal">
              <div class="modal-content">
                <button
                  class="fa-solid fa-close hellHelper"
                  id="closeModale"
                ></button>
                <form
                  method="post"
                  enctype="multipart/form-data"
                  action="/api/video/add"
                  id="uploadForm"
                >
                  <p>ویدیو ی خود را وارد کنید و عنوان مورد نظر را وارد کنید</p>
                  <div class="row">
                    <div class="col">
                      <input
                        required
                        placeholder="عنوان مورد نظر را وارد کنید"
                        type="text"
                        id="nameInput"
                        name="title"
                        value=""
                        style="height: 40px; width: 100%"
                      />
                    </div>
                    <div class="col">
                      <input
                        required
                        type="file"
                        id="videoAdd"
                        name="video"
                        accept=".mp4"
                      />
                    </div>
                    <p id="videoDitail"></p>
                    <input
                      type="submit"
                      name="originalname"
                      value="ثبت"
                      id="submitNamee"
                      style="
                        margin: 10px 0px;
                        border: none;
                        background-color: #2196f3;
                        color: aliceblue;
                        height: 40px;
                      "
                    />
                  </div>
                </form>
              </div>
            </div>
          </div>
          <button class="addNewCat" id="addCatNew" >افزودن ویدیو جدید</button>
        </div>
        <div id="successMessage" class="success-message">با موفقیت انجام شد</div>
      </div>
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />
      <hr />

      <div id="loadingModal" class="modall">
        <div class="modall-content">
          <div class="loader"></div>
        </div>
      </div>

    </section>
    <footer class="py-5 bg-dark">
      <div class="container">
        <p class="m-0 text-center text-white">
          Copyright &copy; Your Website 2023
        </p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/tvscripts.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const content = document.querySelector("#content");
      const myModal = document.querySelector("#myModal");
      const nameInput = document.querySelector("#nameInput");
      const submitName = document.querySelector("#submitName");
      const closeModal = document.querySelector("#closeModal");
      const myModale = document.querySelector("#myModale");
      const addCatNew = document.querySelector("#addCatNew");
      const closeModale = document.querySelector("#closeModale");
      const videoAdd = document.querySelector("#videoAdd");

      const loadingModal = document.querySelector("#loadingModal");
      const videoDitail = document.querySelector("#videoDitail");
      const submitNamee = document.querySelector("#submitNamee");
      const sabt = document.querySelector("#sabt");
      let MainVideo = []

      

      var socket = io();
      socket.emit("getGroup");
      socket.on("jsonFile", async (data) => {
        data["videosDescriptions"].forEach((vid) => {
          if (data["mainVideo"].includes(vid.name)) {
            content.innerHTML += `
                      <li>
                          <div class="row">
                              <div class="col">
                                  <span class="fa-solid fa-remove" id="deleteVideo" data-name="${vid.name}" style="color: red;position: relative; top: 3px;left: 5px; cursor: pointer;"></span>
                                  <a title="برای نمایش ویدیو کلیک کنید " href="/api/video/${vid.name}" target="_blank" style="color:inherit;text-decoration: none;cursor:pointer;">
                                      ${vid.name}
                                  </a>
                              </div>
                              <div class="col">
                                  <span class="fa-solid fa-pen" data-name="${vid.name}" id="editTitle" style="color: #2196f3;position: relative; top: 3px;left: 5px; cursor: pointer;font-size: large;"></span>
                                  ${vid.title}
                              </div>
                              <div class="col">
                                  <p>انتخاب به عنوان ویدیو کلی:</p>
                              </div>
                              <div class="col">
                                  <label class="switch">
                                      <input checked type="checkbox" id="onOff" data-name="${vid.title}" data-cat="${vid.name}" id="onOffVideoButten">
                                      <span class="slider round"></span>
                                  </label>
                              </div>
                          </div>
                      </li>
                      `;
          } else {
            content.innerHTML += `
                      <li>
                          <div class="row">
                              <div class="col">
                                  <span class="fa-solid fa-remove" id="deleteVideo" data-name="${vid.name}" style="color: red;position: relative; top: 3px;left: 5px; cursor: pointer;"></span>
                                  <a title="برای نمایش ویدیو کلیک کنید " href="/api/video/${vid.name}" target="_blank" style="color:inherit;text-decoration: none;cursor:pointer;">
                                  ${vid.name}
                                  </a>
                              </div>
                              <div class="col">
                                  <span class="fa-solid fa-pen" data-name="${vid.name}" id="editTitle" style="color: #2196f3;position: relative; top: 3px;left: 5px; cursor: pointer;font-size: large;"></span>
                                  ${vid.title}
                              </div>
                              <div class="col">
                                  <p>انتخاب به عنوان ویدیو کلی:</p>
                              </div>
                              <div class="col">
                                  <label class="switch">
                                      <input  type="checkbox" id="onOff" data-name="${vid.title}" data-cat="${vid.name}" id="onOffVideoButten">
                                      <span class="slider round"></span>
                                  </label>
                              </div>
                          </div>
                      </li>

                      `;
          }
        });

        const deleteVideo = document.querySelectorAll("#deleteVideo");
        deleteVideo.forEach((butten) => {
          butten.addEventListener("click", (e) => {
            const videoName = e.target.getAttribute("data-name");
            if (confirm(`ایا از حذف ${videoName} اطمینان دارید؟`)) {
              e.target.parentNode.parentNode.parentNode.remove();
              data["videos"] = data["videos"].filter((v) => v !== videoName);
              data["mainVideo"] = data["mainVideo"].filter((v) => v !== videoName);
              data["videosDescriptions"] = data["videosDescriptions"].filter(
                (v) => v.name !== videoName
              );
              data["groups"].forEach((g) => {
                //DONT DELETE CLG
                console.log(g.videos.filter((v) => v !== videoName));
                g.videos = g.videos.filter((v) => v !== videoName);
              });
              data["player"].forEach((player) => {
                console.log(player.playlist.filter((v) => v !== videoName));
                player.playlist = player.playlist.filter(
                  (v) => v !== videoName
                );
              });
              fetch(`/api/video/delete/${videoName}`)

              socket.emit("offClient", "all");
              socket.emit("onClient", "all");
              //socket.emit("reload", "all");
              //socket.emit("onClient", "all");
              socket.emit("changeGroup", data);
            }
          });
        });

        const editTitle = document.querySelectorAll("#editTitle");
        editTitle.forEach((edit) => {
          edit.addEventListener("click", (e) => {
            let videoName = e.target.getAttribute("data-name");
            myModal.style.display = "block";
            myModal.setAttribute("data-name", videoName);
            nameInput.value = videoName;
          });
        });
        closeModal.addEventListener("click", (e) => {
          myModal.style.display = "none";
        });
        submitName.addEventListener("click", (e) => {
          myModal.style.display = "none";
          let name = e.target.parentNode.parentNode.getAttribute("data-name");
          data["videosDescriptions"].forEach((video) => {
            if (video.name == name) {
              video.title = nameInput.value;
            }
          });
          socket.emit("changeGroup", data);
          location.reload();
        });

        const onOff = document.querySelectorAll("#onOff");
        onOff.forEach((onOff) => {
          onOff.addEventListener("change", (e) => {
            let videoName = e.target.getAttribute("data-cat");
            if (data["mainVideo"].includes(videoName)) {
              data["mainVideo"] = data["mainVideo"].filter(
                (v) => v !== videoName
              );
            } else {
              data["mainVideo"].push(videoName);
              MainVideo.push(videoName);
            }
          });
        });

        sabt.addEventListener("click",e=>{
          //console.log(MainVideo)
          let name = []
          document.querySelectorAll("#onOff").forEach(vid =>{
            if(vid.checked){
              name.push(vid.getAttribute("data-cat"))
            }
          })
          for(var i=0;i<MainVideo.length;i++){
            if(i%2==0){
              data["mainVideo"] = name
            }
          }
          console.log(MainVideo)
          socket.emit("changeGroup", data);
          socket.emit("offClient", "all");
          socket.emit("createMainVideoStream","MainVideo")
          loadingModal.style.display="block";
          socket.on("hello",data=>{
            //socket.emit("reload", "all");
            socket.emit("onClient", "all");
            loadingModal.style.display="none";
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            setTimeout(() => {
              successMessage.style.display = 'none';
              //location.reload();
            }, 3000);
          })
          MainVideo = []
        })

        addCatNew.addEventListener("click", (e) => {
          myModale.style.display = "block";
        });
        closeModale.addEventListener("click", (e) => {
          myModale.style.display = "none";
        });
          videoAdd.addEventListener("change", (e) => {
          
          const file = videoAdd.files[0];
          if (file.name.includes(' ') || /[آ-ی]/.test(file.name)) {
              videoDitail.textContent += `ویدیوی مورد نظر شما با حجم ${file.size} و نام ${file.name} انتخاب شده برای افزودن روی دکمه ثبت کلیک کنید`;
              //event.preventDefault(); 
              alert('فایل ویدیوی شما نباید فارسی باشد و نباید اسپیس داشته باشد');
              location.reload();
          }
          videoDitail.textContent = "";
          if (file) {
            videoDitail.textContent += `ویدیوی مورد نظر شما با حجم ${file.size} و نام ${file.name} انتخاب شده برای افزودن روی دکمه ثبت کلیک کنید`;
          }
        });
      });
    </script>
  </body>
</html>
